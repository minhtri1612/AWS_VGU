<!DOCTYPE html>
<html>
    <head>
        <title>Secure Photo Gallery</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .login-section, .upload-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
            table, th, td { border: 1px solid; border-collapse: collapse; padding: 5px; }
            th { background-color: #f0f0f0; }
            #status_message { white-space: pre-wrap; margin-top: 10px; font-family: monospace; }
            input[type="text"], input[type="email"] { width: 250px; padding: 5px; margin: 5px; }
            button { padding: 8px 15px; margin: 5px; cursor: pointer; }
            button:disabled { opacity: 0.5; cursor: not-allowed; }
            .error { color: red; }
            .success { color: green; }
            img.thumbnail { max-width: 50px; max-height: 50px; }
        </style>
    </head>
    <body>
        <!-- Login Section -->
        <div class="login-section">
            <h3>Login</h3>
            <div>
                <label for="email_input">Email: </label>
                <input type="email" id="email_input" placeholder="Enter email">
            </div>
            <div style="margin-top: 5px;">
                <label for="token_input">Token: </label>
                <input type="text" id="token_input" placeholder="Enter token">
            </div>
            <button id="login_button" onclick="handleLogin()">Login</button>
            <div id="login_status"></div>
        </div>

        <!-- Upload Section (hidden until logged in) -->
        <div class="upload-section" id="upload_section" style="display: none;">
            <h3>Upload New File</h3>
            <div>
                <label for="file_input">File: </label>
                <input type="file" id="file_input">
            </div>
            <div style="margin-top: 5px;">
                <label for="description_input">Description: </label>
                <input type="text" id="description_input" placeholder="Enter file description">
            </div>
            <button id="upload_button" onclick="uploadObject()" style="margin-top: 10px;">Upload</button>
            <div id="status_message"></div>
        </div>

        <!-- Bucket List Section -->
        <div>
            <h1>Bucket List</h1>
            <button id="list_button" onclick="fetchListOfObjects()" disabled>List</button>
        </div>
        <div>
            <table id="objectsTable"></table>
        </div>
        <div>
            <img src="" id="download_image" style="max-width: 300px; margin-top: 20px;">
        </div>

        <script>
            // API Gateway base URL
            const API_GATEWAY_BASE = "https://2sw1v03u1g.execute-api.ap-southeast-2.amazonaws.com/dev";
            const AUTH_URL = API_GATEWAY_BASE + "/auth";
            const ORCHESTRATOR_URL = API_GATEWAY_BASE + "/orchestrator";
            const LIST_URL = API_GATEWAY_BASE + "?format=photos";
            
            // Global state for authentication
            let currentEmail = "";
            let currentToken = "";
            let isAuthenticated = false;

            // Initialize - page starts empty (security measure)
            window.addEventListener('DOMContentLoaded', function() {
                // Don't fetch anything until user logs in
                document.getElementById("objectsTable").innerHTML = "";
            });

            // Login handler
            async function handleLogin() {
                const email = document.getElementById("email_input").value.trim();
                const token = document.getElementById("token_input").value.trim();
                const loginStatus = document.getElementById("login_status");

                if (!email || !email.includes("@")) {
                    loginStatus.innerHTML = '<span class="error">Please enter a valid email address</span>';
                    return;
                }

                // If token is provided, verify it
                if (token) {
                    const verified = await verifyToken(email, token);
                    if (verified) {
                        currentEmail = email;
                        currentToken = token;
                        isAuthenticated = true;
                        loginStatus.innerHTML = '<span class="success">Login successful!</span>';
                        document.getElementById("list_button").disabled = false;
                        document.getElementById("upload_section").style.display = "block";
                    } else {
                        loginStatus.innerHTML = '<span class="error">Invalid token. Please check your email and try again.</span>';
                        isAuthenticated = false;
                        document.getElementById("list_button").disabled = true;
                        document.getElementById("upload_section").style.display = "none";
                    }
                } else {
                    // Request token (no SES needed - token returned directly)
                    loginStatus.innerHTML = 'Generating token...';
                    const success = await requestToken(email);
                    if (success) {
                        loginStatus.innerHTML = '<span class="success">Token generated! Token has been auto-filled. Click Login again to verify.</span>';
                    } else {
                        loginStatus.innerHTML = '<span class="error">Failed to generate token. Please try again.</span>';
                    }
                }
            }

            // Request token via email
            async function requestToken(email) {
                try {
                    const response = await fetch(AUTH_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: "request_token",
                            email: email
                        }),
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors'
                    });

                    const data = await response.json();
                    // Token is returned directly in response (no SES needed)
                    if (response.ok && data.token) {
                        // Auto-fill token field
                        document.getElementById("token_input").value = data.token;
                        return true;
                    }
                    return response.ok && data.message && (data.message.includes("generated") || data.message.includes("success"));
                } catch (error) {
                    console.error("Error requesting token:", error);
                    return false;
                }
            }

            // Verify token
            async function verifyToken(email, token) {
                try {
                    const response = await fetch(AUTH_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: "verify_token",
                            email: email,
                            token: token
                        }),
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors'
                    });

                    const data = await response.json();
                    return response.ok && data.valid === true;
                } catch (error) {
                    console.error("Error verifying token:", error);
                    return false;
                }
            }

            // Upload function (requires authentication)
            function uploadObject() {
                if (!isAuthenticated || !currentEmail || !currentToken) {
                    alert("Please login first!");
                    return;
                }

                let file_input = document.getElementById("file_input");
                let desc_input = document.getElementById("description_input");
                let status_div = document.getElementById("status_message");
                
                if (file_input.files.length === 0) {
                    alert("Please select a file first.");
                    return;
                }

                let file = file_input.files[0];
                let description = desc_input.value;
                
                const MAX_SIZE = 6 * 1024 * 1024; // 6MB
                if (file.size > MAX_SIZE) {
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    status_div.innerText = `ERROR: File too large (${sizeMB}MB). Maximum size is 6MB.`;
                    alert(`File is too large (${sizeMB}MB). Maximum size is 6MB.`);
                    return;
                }
                
                status_div.innerText = "Processing upload...";

                let reader = new FileReader();
                reader.onload = () => {
                    const uint8Array = new Uint8Array(reader.result);
                    
                    const body = {
                        "content": uint8Array.toBase64(),
                        "key": file.name,
                        "description": description,
                        "token": currentToken,
                        "email": currentEmail // SECURITY: Send both email and token for hash verification
                    };
                    
                    sendToOrchestrator(body);
                };
                reader.onerror = (e) => {
                    console.log('Error : ' + e.type);
                    status_div.innerText = "Error reading file.";
                };
                reader.readAsArrayBuffer(file);  
            }

            function sendToOrchestrator(jsonBody) {
                let status_div = document.getElementById("status_message");

                fetch(ORCHESTRATOR_URL, {
                     method: 'POST',
                     body: JSON.stringify(jsonBody),
                     headers: { 
                         'Content-Type': 'application/json',
                         'Accept': 'application/json'
                     },
                     mode: 'cors',
                     credentials: 'omit'
                })
                .then((resp) => {
                    if (resp.status === 413) {
                        throw new Error("413: Payload Too Large - File exceeds 6MB limit");
                    }
                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }
                    return resp.json().catch(() => {
                        return resp.text().then(text => {
                            try {
                                return JSON.parse(text);
                            } catch {
                                return { message: text };
                            }
                        });
                    });
                })
                .then(function(response) {
                    console.info('Orchestrator Response:', response);
                    status_div.innerText = JSON.stringify(response, null, 4);
                    // Refresh the list to show the new file
                    if (isAuthenticated) {
                        fetchListOfObjects();
                    }
                })
                .catch(error => {
                    console.error('Upload Error:', error);
                    status_div.innerText = "Upload Failed: " + error.message;
                });
            }

            // Fetch list of objects (requires authentication)
            function fetchListOfObjects() {
                if (!isAuthenticated || !currentEmail || !currentToken) {
                    alert("Please login first!");
                    return;
                }

                fetch(LIST_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        token: currentToken,
                        email: currentEmail // SECURITY: Send both email and token for hash verification
                    }),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                })
                .then((response) => {
                    if (!response.ok) throw new Error(`HTTP error, status = ${response.status}`);
                    return response.text();
                })
                .then((text) => {
                    try {
                        renderListOfObjects(text);
                    } catch (e) {
                        console.error("Error parsing list:", e);
                    }
                })
                .catch((error) => {
                    console.error("Error fetching list:", error);
                    alert("Failed to fetch list. Please verify your token.");
                });
            }

            function renderListOfObjects(listOfObjects) {
                let objectsTable = document.getElementById("objectsTable");
                while (objectsTable.firstChild) {
                    objectsTable.removeChild(objectsTable.lastChild);
                }

                // Create header row
                let headerRow = document.createElement("tr");
                let headers = ["Thumbnail", "Filename", "Description", "Email", "Download", "Delete"];
                headers.forEach(headerText => {
                    let th = document.createElement("th");
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                objectsTable.appendChild(headerRow);

                let objectsArray = JSON.parse(listOfObjects);

                if (objectsArray.length === 0) {
                    let row = document.createElement("tr");
                    let cell = document.createElement("td");
                    cell.colSpan = 6;
                    cell.textContent = "No photos found. Upload some photos to see them here.";
                    cell.style.textAlign = "center";
                    row.appendChild(cell);
                    objectsTable.appendChild(row);
                    return;
                }

                for (let i = 0; i < objectsArray.length; i++) {
                    let row = document.createElement("tr");

                    // Thumbnail Column
                    let thumbCell = document.createElement("td");
                    let thumbImg = document.createElement("img");
                    thumbImg.className = "thumbnail";
                    thumbImg.alt = "Loading...";
                    fetchThumbnail(objectsArray[i].S3Key, thumbImg);
                    thumbCell.appendChild(thumbImg);
                    row.appendChild(thumbCell);

                    // Filename Column
                    let keyCell = document.createElement("td");
                    keyCell.innerText = objectsArray[i].S3Key;
                    row.appendChild(keyCell);

                    // Description Column
                    let descCell = document.createElement("td");
                    descCell.innerText = objectsArray[i].Description || "";
                    row.appendChild(descCell);

                    // Email Column
                    let emailCell = document.createElement("td");
                    emailCell.innerText = objectsArray[i].Email || "";
                    row.appendChild(emailCell);

                    // Download Button Column
                    let downloadCell = document.createElement("td");
                    let downloadButton = document.createElement("button");
                    downloadButton.textContent = "Download";
                    downloadButton.disabled = !isAuthenticated || !currentToken;
                    downloadButton.addEventListener("click", function () {
                        if (!isAuthenticated || !currentToken) {
                            alert("Please login first!");
                            return;
                        }
                        fetchObject(objectsArray[i].S3Key);
                    });
                    downloadCell.appendChild(downloadButton);
                    row.appendChild(downloadCell);

                    // Delete Button Column
                    let deleteCell = document.createElement("td");
                    let deleteButton = document.createElement("button");
                    deleteButton.textContent = "Delete";
                    deleteButton.disabled = !isAuthenticated || !currentToken;
                    deleteButton.addEventListener("click", function () {
                        if (!isAuthenticated || !currentToken) {
                            alert("Please login first!");
                            return;
                        }
                        if (confirm("Are you sure you want to delete " + objectsArray[i].S3Key + "?")) {
                            deleteObject(objectsArray[i].S3Key);
                        }
                    });
                    deleteCell.appendChild(deleteButton);
                    row.appendChild(deleteCell);

                    objectsTable.appendChild(row);
                }
            }

            function fetchThumbnail(key, imgElement) {
                imgElement.alt = "Loading...";
                imgElement.style.display = "inline-block";
                
                fetch(API_GATEWAY_BASE + "?format=resized", {
                    method: 'POST',
                    body: JSON.stringify({ "key": key }),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.blob();
                })
                .then(blob => {
                    const objectURL = URL.createObjectURL(blob);
                    imgElement.src = objectURL;
                    imgElement.alt = key;
                })
                .catch(err => {
                    console.error("Thumbnail error for " + key, err);
                    imgElement.alt = "No Img";
                    imgElement.src = "";
                    imgElement.style.display = "none";
                });
            } 

            function fetchObject(key) {
                if (!isAuthenticated || !currentToken || !currentEmail) {
                    alert("Please login first!");
                    return;
                }

                const body = { "key": key, "token": currentToken, "email": currentEmail };
                fetch(API_GATEWAY_BASE, {
                    method: 'PUT',
                    body: JSON.stringify(body),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                })
                .then(response => {
                    if (!response.ok) throw new Error("Download failed");
                    return response.blob();
                })
                .then((myBlob) => {
                    const objectURL = URL.createObjectURL(myBlob);
                    document.getElementById("download_image").src = objectURL;
                })
                .catch(error => {
                    console.error('Error downloading:', error);
                    alert('Failed to download. Please verify your token.');
                });
            }

            function deleteObject(key) {
                if (!isAuthenticated || !currentToken || !currentEmail) {
                    alert("Please login first!");
                    return;
                }

                const body = { "key": key, "token": currentToken, "email": currentEmail };
                fetch(API_GATEWAY_BASE, {
                    method: 'DELETE', 
                    body: JSON.stringify(body),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                    console.log('Delete successful'); 
                    fetchListOfObjects();
                })
                .catch(error => {
                    console.error('Error deleting:', error.message);
                    alert('Failed to delete. Please verify your token.'); 
                });
            }

            // Polyfill for toBase64
            if (!Uint8Array.prototype.toBase64) {
                Uint8Array.prototype.toBase64 = function() {
                    let binary = '';
                    let len = this.byteLength;
                    for (let i = 0; i < len; i++) {
                        binary += String.fromCharCode(this[i]);
                    }
                    return window.btoa(binary);
                }
            }
        </script>
    </body>
</html>
